# jemalloc 内存统计对 nebula 性能的影响测试

*该测试的目的是衡量 `https://github.com/vesoft-inc/nebula-graph/pull/1116` 的可行性*

1. 测试环境

    物理机配置:2cores/32G x86 centos7 ip:192.168.8.112

    graphd/storaged/metad 各一个实例 rocksDB block cache:4096MB 其余默认

2. 测试数据
| Dataset | PARTITION_NUM | REPLICA_FACTOR|vid_type|
|--|--|--|--|
| ldbc_snb_sf1|24|1|fixed_string(30)|

3. 测试方法

 方法一：同样的语句重复跑多次求时延平均值(避免单次执行的波动)

 方法二：jmeter 进行压力测试，jmeter 会起线程构造不同的语句(起点动态加载)提交给服务，压测指定时间后收集统计信息(p90/p95/p99等)  100线程 100秒

4. 测试用例
 - go 1 step from "vid" over KNOWS  (语句1)
 - go 2 step from "vid" over KNOWS  (语句2)
 - go 3 step from "vid" over KNOWS  (语句3)
 - go 4 step from "vid" over KNOWS  (语句4)
 - match (v:Person) return v        (语句5)
 - go 1 step from "vid" over KNOWS yield $$.Person.firstName (语句6)
 - go 2 step from "vid" over KNOWS yield $$.Person.firstName (语句7)
 - go 3 step from "vid" over KNOWS yield $$.Person.firstName (语句8)
 - go 4 step from "vid" over KNOWS yield $$.Person.firstName (语句9)


5. 测试结果

方法一(起点取“9998”)(memory_stats_collect_interval/big_query_threshold)

 | 语句| disable-stats | enable-stats | epoch(200/*) | epoch(10/*) | epoch(200/0) | epoch(10/0) |epoch(200/100) | epoch(10/100) |
 |--|--|--|--|--|--|--|--|--|
 | 语句1 (19 rows)     |  627/781       |   616/717        |   958/1190        | 887/1088       |881/1066      |888/1062       |890/1083      |852/1044       |
 | 语句2 (1944 rows)   |  5427/7041     |   5644/7342      |   5935/7665       | 6449/8058      |5756/7325     |6003/7591      |5938/7762     |5648/7356      |
 | 语句3 (34893 rows)  |  89460/115852  |   89638/115790   |   92006/119283    | 93923/123314   |97915/124580  |102117/132872  |92017/120459  |91280/117751   |
 | 语句4 (109812 rows) |  355656/438015 |   3512511/4475829|   366826/446963   | 380991/460572  |385753/463167 |392535/477606  |372299/451776 |374449/456635  |
 | 语句5 (9892 rows)   |  909049/974714 |   824437/892825  |   995853/1064706  | 1022619/1088546|976394/1044275|1080674/1148681|872295/942446 |933308/1000099 |
 | 语句6 (19 rows)     |  1514/1720     |   1646/1853      |   1759/1978       | 2026/2296      |2229/2419     |2236/2432      |1675/1912     |1592/1797      |
 | 语句7 (1944 rows)   |  14957/17265   |   13747/15710    |   14621/16433     | 14272/15957    |15806/17801   |16720/18543    |13240/15011   |14241/16380    |
 | 语句8 (34893 rows)  |  152856/180184 |   148288/174541  |   151489/176643   | 146293/172020  |151787/176981 |149834/175443  |146192/172243 |147784/174729  |
 | 语句9 (109812 rows) | 4997062/5824343|   484109/564433  |   500476/590943   | 517843/610360  |527342/615641 |518609/611174  |495021/579253 |526646/610116  |

结论:
 - enable-stats 编译选项对性能影响很小
 - memory_stats_collect_interval 减小后性能有下降 (1-10毫秒级)
 - big_query_threshold 设置为 0 后，大 query 性能会下降 (1毫秒级)
 - 最大性能下降比不超过 0.1 级
 - 客户端延迟基本正常 (后续仅讨论服务端延迟)

---

方法二:

disable-stats:

 | 语句| min | max | avg | median | p90 | p95 | p99 |throughout|
 |--|--|--|--|--|--|--|--|--|
 | 语句1 |0.411/1.479|64.481/99.386|1.941/26.043|1.678/25.833|2.785/28.684|3.336/30.259|8.307/37.798|3832.19|
 | 语句2 |0.671/25.152|126.23/278.494|17.425/104.864|12.855/102.4|37.944/125.938|46.634/136.164|65.754/161.356|951.55|
 | 语句3 |0.739/52.861|1614.849/2414.499|423.705/1013.173|352.099/1004.860|892.316/1376.636|1002.615/1534.897|1152.906/1827.782|97.25|
 | 语句4 |1.593/175.192|5474.719/8662.249|1631.423/3641.570|1509.954/3617.576|3383.96/5067.019|3835.407/5600.925|4640.41/6582.464|26.08|
 | 语句6 |0.556/8.028|85.159/131.2|3.762/49.911|3.51/50.206|5.138/55.309|5.874/57.523|9.828/64.794|2000.59|
 | 语句7 |1.001/106.711|217.023/442.143|30.965/212.130|21.25/208.364|71.242/255.365|87.8/274.984|121.267/312.684|469.94|
 | 语句8 |0.884/167.493|2000.735/3620.059|598.021/1600.918|485.652/1606.318|1331.543/2043.942|1492.524/2257.612|1755.809/2820.007|61.40|
 | 语句9 |2.506/554.547|4657.554/9191.716|1789.258/4948.216|1296.188/4924.397|3851.315/6628.197|4219.602/7149.82|4524.185/8217.569|18.75|


  enable-stats:

   | 语句| min | max | avg | median | p90 | p95 | p99 |throughout|
   |--|--|--|--|--|--|--|--|--|
   | 语句1 |0.411/1.379|47.721/80.933|1.774/24.964|1.597/24.876|2.576/27.568|2.998/28.693|5.055/35.388|3998.06|
   | 语句2 |0.642/44.374|146.835/241.997|16.380/101.905|12.157/100.065|35.853/120.511|43.687/129.811|60.329/153.234|979.40|
   | 语句3 |1.082/61.005|1629.622/2397.918|439.079/1002.755|421.039/994.539|857.916/1360.618|962.015/1520.52|1137.517/1808.229|98.12|
   | 语句4 |0.648/258.517|4871.884/7994.783|1572.054/3767.246|1390.478/3738.52|3247.709/5111.606|3598.42/5519.11|4294.713/7023.599|25.41|
   | 语句6 |0.633/2.705|74.463/142.844|3.795/50.593|3.532/50.465|5.154/56.127|5.849/58.686|9.543/78.651|1973.07|
   | 语句7 |0.849/97.22|207.364/386.703|31.012/209.781|20.992/206.803|72.524/249.112|89.288/267.561|123.665/308.46|475.34|
   | 语句8 |0.876/77.92|1897.23/3261.232|609.152/1551.622|530.321/1555.174|1281.592/1990.561|1415.65/2214.556|1633.393/2643.657|62.87|
   | 语句9 |1.936/130.197|5974.845/9463.069|1973.256/4957.744|1716.098/4898.707|4196.952/6813..094|4634.92/7319.945|5683.472/8165.48|18.99|

结论:
 - 加入 jemalloc `--enable-stats` 编译选项后，除语句9(4步带属性)性能有所下降外，其余基本相同或有小幅提升。
 - 该编译选项是运行时性能安全的

epoch (10/100)

 | 语句| min | max | avg | median | p90 | p95 | p99 |throughout|
 |--|--|--|--|--|--|--|--|--|
 | 语句1 |0.596/15.178|41.124/86.687|2.274/33.956|2.014/34.039|3.436/38.567|4.095/40.716|7.224/47.821|2940.07|
 | 语句2 |0.865/61.789|130.139/284.48|15.820/122.610|11.044/119.269|34.557/37.944|43.356/162.938|63.886/190.808|814.08|
 | 语句3 |1.379/141.49|1268.245/2338.784|321.232/1076.175|204.238/1064.088|784.546/1377.111|871.791/1002.615|1099.426/1806.786|90.98|
 | 语句4 |1.951/635.056|4428.092/7722.591|1044.865/3831.746|698.628/3800.37|2576.361/4858.893|3073.74/5237.023|4149.536/6153.401|24.93|
 | 语句6 |0.822/31.43|58.828/129.562|4.245/56.474|3.819/56.37|5.972/63.416|7.051/67.8|14.87/84.081|1767.985|
 | 语句7 |1.214/109.92|230.676/458.926|31.582/244.847|21.958/239.715|70.822/296.673|88.104/316.499|132.869/368.137|407.32|
 | 语句8 |1.366/220.812|1915.441/3550.845|456.268/1743.731|293.270/1744.501|1169.553/2180.378|1340.853/2317.84|1527.411/2703.837|55.89|
 | 语句9 |2.015/920.252|5348.795/10218.488|1558.132/5344.665|1067.343/5298.3235|3821.468/7110.17|4315.334/7679.612|4871.169/9032.013|17.58|

结论:
 - 吞吐量与 enable-stats 相比有所下降

epoch(max/max):
 1.856/25.677  16.994/101.326  470.187/988.761  1622.704/3647.499
 3.848/50.591  32.499/217.844  627.597/1589.090 1904.461/4992.922

  | 语句| min | max | avg | median | p90 | p95 | p99 |throughout|
  |--|--|--|--|--|--|--|--|--|
  | 语句1 |0.407/1.241|41.193/85.422|1.856/25.677|1.679/25.565|2.728/28.083|3.172/29.209|5.066/34.314|3886.726|
  | 语句2 |0.599/27.732|136.998/226.286|16.994/101.326|12.481/100.115|37.51/119.411|46.007/128.345|63.136/147.091|985.204|
  | 语句3 |0.953/60.774|1850.156/2637.712|470.187/988.760|458.486/974.393|927.383/1362.07|1038.404/1484.123|1167.909/1773.992|98.91|
  | 语句4 |1.375/182.368|5598.487/8148.606|1622.704/3647.499|1528.126/3623.04|3375.909/5089.172|3735.285/5678.796|4143.494/6697.706|26.11|
  | 语句6 |0.636/16.039|60.389/116.772|3.848/50.591|3.607/50.722|5.278/56.216|5.998/57.999|9.505/62.423|1973.53|
  | 语句7 |0.782/103.666|250.43/547.217|32.499/217..844|22.011/214.362|75.123/259.122|92.905/278.412|128.506/325.247|457.50|
  | 语句8 |1.381/130.382|2031.843/3231.012|627.597/1589.090|542.817/1605.55|1368.583/2073.94|1498.05/2266.845|1675.806/2695.876|61.133|
  | 语句9 |1.901/414.601|5101.768/10475.999|1904.461/4992.922|1544.586/4980.841|3961.984/6744.221|4329.815/7103.553|4824.955/7794.37|18.44|

结论:
 - epoch(max/max) 不收集统计信息，测试结果和 enable-stats 基本一致，符合预期

---
